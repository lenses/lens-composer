<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../paper-toolbar/paper-toolbar.html"> 
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="lens-node.html"> 
<link rel="import" href="lens-component-menu.html"> 

<!--

A component used to create new lenses, by connecting components and passing data through them.

Example:

    <lens-composer></lens-composer>

@demo
-->

<dom-module id="lens-composer">
    <style>
      :host { 
        display: block;
        position: absolute;
        height: 100%;
        width: 100%;
        font-family: sans-serif;
      }

      /* GENERAL STYLES */ 
      .padded {
        padding: 10px;
        box-sizing: border-box;
      }

      .btn {
        border-radius: 200px;
        text-align: center;
        cursor: pointer;
        display: inline-block;
        margin: 0 auto;
        font-size: 0.8em;
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      .btn-primary {
        background-color: #1CD4CA;
        color: white;
      }

      .btn-outline {
        border: 2px solid black;
      }

      /* NAV STYLES */ 
      #nav {
        width: 100%;
        height: 85px;
        box-sizing: border-box;
        border-bottom: 3px solid #eee;
      }

      #lens-info {
        display: inline-block;
        position: relative;
        float: left;
        padding-left: 20px;
        box-sizing: border-box;
      }

      .title {
        /* TODO: Style title text */
      }

      .author {
        /* TODO: Style author text */
      }

      #save {
        display: inline-block;
        float: right;
        height: 100%;
        width: 80px;
        border-left: 3px solid #eee;
        box-sizing: border-box;
      }
      
      .icon {
        display: block;
        margin: 0 auto;
        margin-top: 25px; /* TODO: make this more responsive -- table cell vertical align? */
      }

      /* CONTROL PANEL STYLES */ 
      #control-panel {
        display: inline-block;
        width: 20%;
        min-width: 200px;
        height: 100%;
        left: 0;
        top: 0;
        overflow: hidden;
        border-right: 3px solid #eee;
      }

      /* MAIN PANEL STYLES */
      #main {
        width: 80%;
        height: 100%;
        overflow: hidden;
        display: inline-block;
        float: right;
      }

      #componentList {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: 1;
      }

      #component {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: 2;
        background-color: white;
      }

      #component > ::content {
        width: 100%;
        height: 100%;
      }

      .hidden {
        display: none;
      }

    </style>
    <template>
      <!-- HEADER -->
      <div id="nav">
        <div id="lens-info" class="center horizontal layout flex">
          <p class="title">Title</p>
          <p>Author</p>
        </div>
        <div id="save" class="center horizontal layout">
          <img class="icon" src="assets/publish.png" width="50%">
        </div>
      </div>


      <!-- TRACKS -->
      <div id="control-panel" class="padded">
        <template is="dom-if" if="{{nodes.length}}">
          <div class="btn btn-outline padded" on-click="addTrack" data-node-type="input">Add new track</div>
        </template>
        
        <template id="tracks" is="dom-repeat" items="{{nodes}}" as="node" observe="type tag.component.name">
          <li>
            <!-- <div class="step"></div> -->
            <div on-click="_displayNode" data-node-index$="{{index}}">{{node.tag.component.name::component-name-changed}}</div>
            <div>{{node.type}}</div>
          </li>
        </template>
        <!-- <template is="dom-if" if="{{!nodes.length}}"> -->
          <!-- <li on-click="_displayNode">+</li> -->
        <!-- </template> -->
      </div>
      
      

      <!-- MAIN FRAME -->
      <div id="main">
        <template is="dom-repeat" items="{{nodes}}" as="node">
          <div class$="lens-node"> <!-- TODO: make this observe changes in current node --> 
            <content select="#{{node.id}}"></content>
          </div>
        </template>
        <!-- <template is="dom-if" if="{{_currentNode}}">
          <div id="component">
            <content select="#{{_currentNode.id}}"></content>
          </div>
        </template> -->
      </div>



      <!-- HIDDEN LENS NODES -->
      <div class="hidden">
        <template is="dom-repeat" items="{{nodes}}" as="node">
          <!-- <content select="#{{node.id}}"></content> -->
          <!-- <lens-node id="{{node.id}}" type="{{node.type}}"></lens-node> -->
        </template>
      </div>
    </template>
  
  <script>
    Polymer({
      is: 'lens-composer',
      properties: {
        /**
         * prevState is an object containing data required to rebuild a lens.
         * Example:
         *   {
         *     nodes: [{ 'type': 'input', 'id':'lens-node-0',  'componentName': 'lens-viz-g-bar'}],
         *   }
         * @type {Object}
         */
        prevState: {
          type: Object,
          value: function(){ return {     nodes: [
              { 'type': 'input', 'id':'lens-node-0',  'componentName': 'lens-viz-g-bar'},
              { 'type': 'transform', 'id':'lens-node-1',  'componentName': 'lens-viz-g-map'}
            ] }; }
        },
        nodes: {
          type: Array,
          value: function(){ return []; },
          notify: true
        },
        // INITIALIZE PRIVATE
        _uniqueCounter: {
          type: Number,
          value: 0
        },
        _currentNode: {
          type: Object,
          value: {},
          notify: true,
          observer: '_currentNodeChanged'
        },
        componentList: {
          type: Array,
         value: function(){
          return [
            {name:'lens-data-table', friendly: 'Data table', type: 'input'},
            {name:'lens-viz-g-map', friendly: 'Google Map', type: 'visualize'},
            {name:'lens-viz-g-bar-chart', friendly: 'Google Bar Chart', type: 'visualize'}
          ];
         } 
        }
      },
      listeners: {
        'lens-add-element': 'addNewComponent', // not functional
        'component-name-changed': 'componentNameChanged' // not functional

      },
      observers: {
        'nodesChanged': 'nodesChanged(node.*)' // not functional
      },
      ready: function(){

        if (this.prevState && this.prevState.nodes && this.prevState.nodes.length){
      
          this.loadLens(this.prevState);
        } else {
          var newNode = this.createNode('input');
          this._currentNode = {
            type: newNode.type,
            id: newNode.id,
            tag: newNode
          };
          this.addNode(this._currentNode);   

        }

      },
      loadLens: function(lensData){
        var self = this;
        // this.nodes = lensData.nodes;
        lensData.nodes.forEach(function(node){
          // var newNode = self.createNode(node.type, node.id);
          
          // node.id = newNode.id;
          self.push('nodes', node);

        })
    
        // self._setUniqueCounter();
          
        // Recreate nodes and components
        self.rebuildNodes(self.nodes);
          
      },
      rebuildNodes: function(nodes){
        var self = this;
        nodes.forEach(function(node, i){
          var nodeExists = document.querySelector('#'+node.id) ? true : false;

          if (!nodeExists){
             console.log("node does not exist, building");
             // if(node.type == 'input'){ self._numTracks++; }
             node.tag = self.createNode(node.type, node.id);
             
             Polymer.dom(self).appendChild(node.tag);

             // TODO: Set all the saved attrs for the node
            if (i>0){
              // self._connectNodes();
            }

            if (node.componentName){ 
              // TODO: recreate component w/state inside lens-node
              // var componentState = node.componentState ? node.componentState : null; 
              node.tag.createElementFromSavedData(node.componentName);
              }
          }
        });
        self.set('_currentNode',self.nodes[0]);

      },
      clearLens: function(){
        // Wipe the slate clean and start from scratch
      },
      addNewComponent: function(e, detail){
        var self = this;
        // var name = detail.name,

        // self._currentNode.addComponent(detail.name, detail.type);
        // Adds a new external component to the list
      },
      createNode: function(type, id, track){
        // Creates a new lens-node
        var newNode = document.createElement('lens-node');

        newNode.id = id || this._generateUniqueId('lens-node');
        newNode.type = type;
        // this.appendChild(newNode);
        
        return newNode;

      },
      addNode: function(node){
        console.log(node);
        // this.appendChild(node.tag); 
        Polymer.dom(this).appendChild(node.tag)
        this.push('nodes', node); 

        return node;

      },
      deleteNode: function(){
        // Deletes a lens-node
      },
      connectNodes: function(){
        // Connects I/O of nodes 
      },
      addTrack: function(){
        // Create a new track
      },
      _generateUniqueId: function(elName){
        // Generates a unique id for lens-node
        var uniqueId = elName + '-' + this._uniqueCounter;
        
        this._uniqueCounter+= 1;

        return uniqueId;
      },  
      // _isNodeSelected: function(nodeId){
        
      //   return this._currentNode.id === nodeId ? "" : "hidden";
      // },
      _displayNode: function(e){
        var self = this,
            index = e.target.dataset.nodeIndex;
        this._currentNode.tag.classList.add('hidden');

        // Set `selected` on all nodes to false    
        // self.nodes.forEach(function(node, i){
          // node.selected = false;
        // })

        // Select the correct node or create a new one
        if (index || index == 0){
          if (self.nodes[index]){
            self.set('_currentNode', self.nodes[index]);
            self._currentNode.tag.classList.remove('hidden');
            // console.log(self._currentNode);
            // self.set('_currentNode.selected', true);
            // self.nodes[index].selected = true;
          } else {
            console.log("display component menu")
            // TODO: if the button to add a new node is clicked, need to create it (after a component is selected?)
          }
        } else {
          self.set('_currentNode', {});
        }


      },
      componentNameChanged: function(){
        console.log('componentNameChanged');
        // this.notifyPath('node')
        this.$.tracks.render(); // not functional
      },
      nodesChanged: function(node){
        console.log('nodes changed');
      },
      isCurrent: function(node){
        if (node.id === this._currentNode.id){
          return "";
        } else {
          return "hidden";
        }
        
      },
      _currentNodeChanged: function(){

      }
     
    });
  </script>
</dom-module>